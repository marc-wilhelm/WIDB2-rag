services:
  # Python Environment für Entwicklung
  python-env:
    image: widb2-rag:latest
    container_name: python-env
    working_dir: /app
    volumes:
      - ./:/app
    stdin_open: true
    tty: true
    command: sleep infinity
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - rag-network

  # Weaviate Vektordatenbank
  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.32.2
    container_name: weaviate
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      ENABLE_MODULES: text2vec-model2vec
      MODEL2VEC_INFERENCE_API: http://text2vec-model2vec:8080
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      CLUSTER_HOSTNAME: 'node1'
    volumes:
      - weaviate_data:/var/lib/weaviate
    networks:
      - rag-network

  # Embedding Model für Weaviate
  text2vec-model2vec:
    image: cr.weaviate.io/semitechnologies/model2vec-inference:minishlab-potion-base-32M
    container_name: text2vec-model2vec
    networks:
      - rag-network

  # RAG Streamlit-Anwendung
  widb2-rag:
    build:
      context: .
      dockerfile: Dockerfile
    image: widb2-rag:latest
    container_name: widb2-rag
    working_dir: /app
    volumes:
      - ./:/app
    ports:
      - "8501:8501"
    environment:
      - PYTHONUNBUFFERED=1
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - WEAVIATE_URL=http://weaviate:8080
    depends_on:
      - weaviate
    networks:
      - rag-network

volumes:
  weaviate_data:

networks:
  rag-network:
    driver: bridge